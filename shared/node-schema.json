{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Visual Compute Engine Node Schema",
  "description": "Shared schema defining node types and their handles. Used by both editor-ui and compute engine.",
  "version": "1.1.5",
  "nodes": {
    "request": {
      "description": "Entry point for incoming requests",
      "inputs": [],
      "outputs": [
        { "id": "request", "label": "Request", "type": "geometry" }
      ]
    },
    "condition": {
      "description": "Single condition evaluation",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [
        { "id": "true", "label": "True", "type": "bool" },
        { "id": "false", "label": "False", "type": "bool" }
      ],
      "data": {
        "field": "string (path, method, clientIp, country, userAgent, host, header, asn, ja3)",
        "operator": "string (equals, notEquals, contains, notContains, startsWith, endsWith, matches, in, notIn, inCidr)",
        "value": "string"
      }
    },
    "ruleGroup": {
      "description": "Multiple conditions with AND/OR logic",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [
        { "id": "match", "label": "Match", "type": "bool" },
        { "id": "noMatch", "label": "No Match", "type": "bool" }
      ],
      "data": {
        "name": "string",
        "logic": "AND | OR",
        "conditions": "array of { field, operator, value }"
      }
    },
    "action": {
      "description": "Terminal action (block/allow/redirect/challenge/log)",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [],
      "data": {
        "action": "block | allow | redirect | challenge | log",
        "statusCode": "number (for block: 400/403/429/503, for redirect: 301/302/307/308)",
        "message": "string (for block/log)",
        "url": "string (for redirect - target URL)",
        "preserveQuery": "boolean (for redirect - preserve query string)"
      }
    },
    "backend": {
      "description": "Route to a backend origin",
      "inputs": [
        { "id": "route", "label": "Route", "type": "bool" }
      ],
      "outputs": [
        { "id": "response", "label": "Response", "type": "geometry" },
        { "id": "error", "label": "Error", "type": "bool" }
      ],
      "data": {
        "name": "string",
        "host": "string",
        "port": "number",
        "useTLS": "boolean"
      }
    },
    "rateLimit": {
      "description": "Rate limiting check using Fastly Edge Rate Limiting",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [
        { "id": "exceeded", "label": "Exceeded", "type": "bool" },
        { "id": "ok", "label": "OK", "type": "bool" }
      ],
      "data": {
        "limit": "number (max requests)",
        "windowUnit": "string (second, minute, hour)",
        "keyBy": "string (ip, fingerprint, header, path)",
        "headerName": "string (when keyBy is header)"
      }
    },
    "header": {
      "description": "Set or remove request/response headers",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [
        { "id": "out", "label": "Out", "type": "bool" }
      ],
      "data": {
        "operation": "string (set, remove)",
        "name": "string (header name)",
        "value": "string (header value, for set)"
      }
    },
    "redirect": {
      "description": "Redirect to a different URL",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [],
      "data": {
        "url": "string (target URL)",
        "statusCode": "number (301, 302, 307, 308)",
        "preserveQuery": "boolean (keep query string)"
      }
    },
    "listLookup": {
      "description": "Check if value exists in a list",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" }
      ],
      "outputs": [
        { "id": "found", "label": "Found", "type": "bool" },
        { "id": "notFound", "label": "Not Found", "type": "bool" }
      ],
      "implemented": false
    },
    "score": {
      "description": "Anomaly scoring and threshold checking",
      "inputs": [
        { "id": "trigger", "label": "Trigger", "type": "bool" },
        { "id": "score_in", "label": "Score In", "type": "number" }
      ],
      "outputs": [
        { "id": "exceeded", "label": "Exceeded", "type": "bool" },
        { "id": "ok", "label": "OK", "type": "bool" },
        { "id": "score_out", "label": "Score Out", "type": "number" }
      ],
      "implemented": false
    },
    "logic": {
      "description": "Boolean logic (AND/OR/NOT)",
      "inputs": [
        { "id": "a", "label": "A", "type": "bool" },
        { "id": "b", "label": "B", "type": "bool" }
      ],
      "outputs": [
        { "id": "true", "label": "True", "type": "bool" },
        { "id": "false", "label": "False", "type": "bool" }
      ],
      "implemented": false
    }
  },
  "operators": {
    "string": [
      { "id": "equals", "label": "equals" },
      { "id": "notEquals", "label": "not equals" },
      { "id": "contains", "label": "contains" },
      { "id": "notContains", "label": "not contains" },
      { "id": "startsWith", "label": "starts with" },
      { "id": "endsWith", "label": "ends with" },
      { "id": "matches", "label": "matches (regex)" },
      { "id": "in", "label": "in list" },
      { "id": "notIn", "label": "not in list" },
      { "id": "exists", "label": "exists" },
      { "id": "notExists", "label": "not exists" }
    ],
    "number": [
      { "id": "equals", "label": "equals" },
      { "id": "notEquals", "label": "not equals" },
      { "id": "greaterThan", "label": "greater than" },
      { "id": "lessThan", "label": "less than" },
      { "id": "greaterOrEqual", "label": "greater or equal" },
      { "id": "lessOrEqual", "label": "less or equal" },
      { "id": "in", "label": "in list" },
      { "id": "notIn", "label": "not in list" }
    ],
    "ip": [
      { "id": "equals", "label": "equals" },
      { "id": "notEquals", "label": "not equals" },
      { "id": "inCidr", "label": "in CIDR range" },
      { "id": "notInCidr", "label": "not in CIDR range" },
      { "id": "in", "label": "in list" },
      { "id": "notIn", "label": "not in list" }
    ],
    "boolean": [
      { "id": "equals", "label": "equals" },
      { "id": "notEquals", "label": "not equals" }
    ]
  },
  "fieldCategories": {
    "Connection": ["clientIp", "asn"],
    "Geolocation": ["country", "countryCode3", "continent", "city", "region", "postalCode", "latitude", "longitude", "metroCode", "utcOffset", "connSpeed", "connType"],
    "Proxy Detection": ["proxyType", "proxyDescription", "isHostingProvider"],
    "Device Detection": ["isBot", "botName", "isMobile", "isTablet", "isDesktop", "isSmartTV", "isGameConsole", "deviceName", "deviceBrand", "deviceModel", "browserName", "browserVersion", "osName", "osVersion"],
    "Request": ["method", "path", "host", "userAgent"],
    "TLS Fingerprint": ["ja3", "ja4"],
    "Custom": ["header"]
  },
  "fields": [
    { "id": "clientIp", "label": "Client IP", "type": "ip", "category": "Connection" },
    { "id": "asn", "label": "ASN", "type": "number", "category": "Connection" },

    { "id": "country", "label": "Country", "type": "string", "category": "Geolocation", "description": "ISO 3166-1 alpha-2 (US, GB, DE)" },
    { "id": "countryCode3", "label": "Country Code (3)", "type": "string", "category": "Geolocation", "description": "ISO 3166-1 alpha-3 (USA, GBR, DEU)" },
    { "id": "continent", "label": "Continent", "type": "string", "category": "Geolocation", "description": "AF, AN, AS, EU, NA, OC, SA" },
    { "id": "city", "label": "City", "type": "string", "category": "Geolocation" },
    { "id": "region", "label": "Region", "type": "string", "category": "Geolocation", "description": "ISO 3166-2 subdivision (CA, TX, etc.)" },
    { "id": "postalCode", "label": "Postal Code", "type": "string", "category": "Geolocation" },
    { "id": "latitude", "label": "Latitude", "type": "number", "category": "Geolocation" },
    { "id": "longitude", "label": "Longitude", "type": "number", "category": "Geolocation" },
    { "id": "metroCode", "label": "Metro Code", "type": "number", "category": "Geolocation", "description": "Nielsen DMA code" },
    { "id": "utcOffset", "label": "UTC Offset", "type": "number", "category": "Geolocation", "description": "Timezone offset in hours" },
    { "id": "connSpeed", "label": "Connection Speed", "type": "string", "category": "Geolocation", "description": "broadband, cable, dialup, mobile, etc." },
    { "id": "connType", "label": "Connection Type", "type": "string", "category": "Geolocation", "description": "wired, wifi, mobile, satellite" },

    { "id": "proxyType", "label": "Proxy Type", "type": "string", "category": "Proxy Detection", "description": "anonymous, public, transparent, vpn" },
    { "id": "proxyDescription", "label": "Proxy Description", "type": "string", "category": "Proxy Detection", "description": "tor-exit, tor-relay, hosting, etc." },
    { "id": "isHostingProvider", "label": "Is Hosting Provider", "type": "boolean", "category": "Proxy Detection" },

    { "id": "isBot", "label": "Is Bot", "type": "boolean", "category": "Device Detection" },
    { "id": "botName", "label": "Bot Name", "type": "string", "category": "Device Detection" },
    { "id": "isMobile", "label": "Is Mobile", "type": "boolean", "category": "Device Detection" },
    { "id": "isTablet", "label": "Is Tablet", "type": "boolean", "category": "Device Detection" },
    { "id": "isDesktop", "label": "Is Desktop", "type": "boolean", "category": "Device Detection" },
    { "id": "isSmartTV", "label": "Is Smart TV", "type": "boolean", "category": "Device Detection" },
    { "id": "isGameConsole", "label": "Is Game Console", "type": "boolean", "category": "Device Detection" },
    { "id": "deviceName", "label": "Device Name", "type": "string", "category": "Device Detection" },
    { "id": "deviceBrand", "label": "Device Brand", "type": "string", "category": "Device Detection" },
    { "id": "deviceModel", "label": "Device Model", "type": "string", "category": "Device Detection" },
    { "id": "browserName", "label": "Browser Name", "type": "string", "category": "Device Detection" },
    { "id": "browserVersion", "label": "Browser Version", "type": "string", "category": "Device Detection" },
    { "id": "osName", "label": "OS Name", "type": "string", "category": "Device Detection" },
    { "id": "osVersion", "label": "OS Version", "type": "string", "category": "Device Detection" },

    { "id": "method", "label": "Method", "type": "string", "category": "Request" },
    { "id": "path", "label": "Path", "type": "string", "category": "Request" },
    { "id": "host", "label": "Host", "type": "string", "category": "Request" },
    { "id": "userAgent", "label": "User Agent", "type": "string", "category": "Request" },

    { "id": "ja3", "label": "JA3 Fingerprint", "type": "string", "category": "TLS Fingerprint" },
    { "id": "ja4", "label": "JA4 Fingerprint", "type": "string", "category": "TLS Fingerprint" },

    { "id": "header", "label": "Header", "type": "string", "category": "Custom", "hasParam": true, "paramLabel": "Header Name" }
  ]
}
